'use client';

import React, { useEffect, useState } from 'react';

// í†µí™” ì •ë³´ ì •ì˜
const currencies = [
  { code: 'KRW', name: 'ì›í™”', flag: 'ğŸ‡°ğŸ‡·' },
  { code: 'EUR', name: 'ìœ ë¡œ', flag: 'ğŸ‡ªğŸ‡º' },
  { code: 'USD', name: 'ë‹¬ëŸ¬', flag: 'ğŸ‡ºğŸ‡¸' },
  { code: 'JPY', name: 'ì—”í™”', flag: 'ğŸ‡¯ğŸ‡µ' },
  { code: 'CNY', name: 'ìœ„ì•ˆ', flag: 'ğŸ‡¨ğŸ‡³' },
];

// API ì‘ë‹µ íƒ€ì… ì •ì˜
interface ExchangeRateResponse {
  base: string;
  rates: Record<string, number>;
  date: string;
  timestamp: number;
}

// í™˜ìœ¨ ë°ì´í„° íƒ€ì…
interface ExchangeRateData {
  from: string;
  to: string;
  rate: number;
  change: number;
  lastUpdated: string;
}

const ForexHeatmap: React.FC = () => {
  const [currentTime, setCurrentTime] = useState<string>('');
  const [exchangeRates, setExchangeRates] = useState<ExchangeRateData[]>([]);
  const [loading, setLoading] = useState(true);
  const [lastUpdated, setLastUpdated] = useState<string>('');
  const [errorMessage, setErrorMessage] = useState<string>('');

  // í™˜ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const fetchExchangeRates = async () => {
    try {
      setLoading(true);
      setErrorMessage('');
      
      // ê° í†µí™”ìŒì— ëŒ€í•œ í™˜ìœ¨ ìƒì„±
      let allRates: ExchangeRateData[] = [];
      
      for (const baseCurrency of currencies) {
        for (const targetCurrency of currencies) {
          if (baseCurrency.code === targetCurrency.code) continue;
          
          // ì„ì˜ì˜ í™˜ìœ¨ ë°ì´í„° ìƒì„±
          const baseRate = getInitialRate(baseCurrency.code, targetCurrency.code);
          const prevRate = exchangeRates.find(
            rate => {
              if (rate.from === baseCurrency.code) {
                return rate.to === targetCurrency.code;
              }
              return false;
            }
          );
          
          // ì•½ê°„ì˜ ë³€ë™í­ ì¶”ê°€ (-0.2% ~ +0.2%)
          const variation = (Math.random() - 0.5) * 0.4;
          const newRate = baseRate * (1 + variation / 100);
          
          // ë³€í™”ìœ¨ ê³„ì‚°
          const change = prevRate ? ((newRate - prevRate.rate) / prevRate.rate) * 100 : 0;
          
          allRates.push({
            from: baseCurrency.code,
            to: targetCurrency.code,
            rate: newRate,
            change,
            lastUpdated: new Date().toISOString()
          });
        }
      }
      
      setExchangeRates(allRates);
      const now = new Date();
      setLastUpdated(now.toLocaleTimeString());
      setLoading(false);
    } catch (error) {
      console.error('í™˜ìœ¨ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
      setErrorMessage('í™˜ìœ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      setLoading(false);
    }
  };

  // ì´ˆê¸° í™˜ìœ¨ ê°’ ì„¤ì •
  const getInitialRate = (from: string, to: string): number => {
    const rates: Record<string, number> = {
      'KRW/USD': 0.00075,
      'KRW/JPY': 0.11,
      'KRW/CNY': 0.0053,
      'KRW/EUR': 0.00069,
      'USD/KRW': 1330.42,
      'USD/JPY': 147.33,
      'USD/CNY': 7.14,
      'USD/EUR': 0.92,
      'JPY/KRW': 903, // 100ì—”ë‹¹ ì›í™”ê°’
      'JPY/USD': 0.0068,
      'JPY/CNY': 0.048,
      'JPY/EUR': 0.0062,
      'CNY/KRW': 186.33,
      'CNY/USD': 0.14,
      'CNY/JPY': 20.63,
      'CNY/EUR': 0.13,
      'EUR/KRW': 1450.53,
      'EUR/USD': 1.09,
      'EUR/JPY': 160.21,
      'EUR/CNY': 7.76,
    };
    
    return rates[`${from}/${to}`] || 1;
  };

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    // ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    const updateTime = () => {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      setCurrentTime(`${hours}:${minutes}:${seconds}`);
    };

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    updateTime();
    fetchExchangeRates();
    
    // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì„¤ì •
    const timeInterval = setInterval(updateTime, 1000);
    const ratesInterval = setInterval(fetchExchangeRates, 30000); // 30ì´ˆë§ˆë‹¤ í™˜ìœ¨ ì—…ë°ì´íŠ¸
    
    return () => {
      clearInterval(timeInterval);
      clearInterval(ratesInterval);
    };
  }, []);

  // íŠ¹ì • í†µí™”ìŒì˜ í™˜ìœ¨ ì¡°íšŒ
  const getRateData = (from: string, to: string): ExchangeRateData | undefined => {
    return exchangeRates.find(rate => {
      if (rate.from === from) {
        return rate.to === to;
      }
      return false;
    });
  };

  // í™˜ìœ¨ í¬ë§·íŒ…
  const formatRate = (rate: number) => {
    if (rate < 0.01) return rate.toFixed(5);
    if (rate < 1) return rate.toFixed(4);
    if (rate < 10) return rate.toFixed(3);
    return rate.toFixed(2);
  };

  // ë³€í™”ìœ¨ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ê²°ì •
  const getChangeStyle = (change: number) => {
    if (change > 0.1) return 'bg-green-100 text-green-700';
    if (change < -0.1) return 'bg-red-100 text-red-700';
    return 'bg-gray-50 text-gray-700';
  };

  return (
    <div className="w-full h-full bg-white rounded-xl shadow-lg border-4 border-blue-500 p-4" style={{ maxWidth: '650px', margin: '0 auto' }}>
      <div className="w-full mb-3">
        <h2 className="text-lg font-semibold text-gray-800">ì‹¤ì‹œê°„ í™˜ìœ¨í‘œ</h2>
        <div className="flex items-center justify-between text-sm text-gray-500">
          <div className="flex items-center">
            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
            <span>ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</span>
            <span className="mx-2">â€¢</span>
            <span>{currentTime}</span>
          </div>
          {lastUpdated ? (
            <div className="text-xs text-gray-400">
              ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {lastUpdated}
            </div>
          ) : null}
        </div>
      </div>

      {errorMessage ? (
        <div className="p-4 border border-red-300 bg-red-50 text-red-700 rounded mb-4">
          {errorMessage}
          <button 
            className="ml-2 underline text-blue-500"
            onClick={fetchExchangeRates}
          >
            ë‹¤ì‹œ ì‹œë„
          </button>
        </div>
      ) : loading ? (exchangeRates.length === 0 ? (
        <div className="flex items-center justify-center p-12">
          <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
      ) : null) : (
        <div className="overflow-x-auto overflow-y-hidden bg-blue-100 p-1 rounded-lg border-2 border-blue-400">
          <table className="w-full border-collapse table-fixed text-sm" style={{ maxWidth: '600px' }}>
            <thead>
              <tr>
                <th className="w-16 h-14 bg-blue-200 border-2 border-blue-300"></th>
                {currencies.map((currency) => (
                  <th key={currency.code} className="w-16 h-14 bg-blue-200 border-2 border-blue-300 text-center">
                    <div className="flex flex-col items-center justify-center">
                      <div className="text-xl">{currency.code === 'KRW' ? 'ğŸ‡°ğŸ‡·' : 
                                           currency.code === 'EUR' ? 'ğŸ‡ªğŸ‡º' : 
                                           currency.code === 'USD' ? 'ğŸ‡ºğŸ‡¸' : 
                                           currency.code === 'JPY' ? 'ğŸ‡¯ğŸ‡µ' : 
                                           currency.code === 'CNY' ? 'ğŸ‡¨ğŸ‡³' : ''}</div>
                      <div className="font-medium text-xs">{currency.code}</div>
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {currencies.map((fromCurrency) => (
                <tr key={fromCurrency.code}>
                  <td className="w-16 h-14 bg-blue-200 border-2 border-blue-300 text-center">
                    <div className="flex flex-col items-center justify-center">
                      <div className="text-xl">{fromCurrency.code === 'KRW' ? 'ğŸ‡°ğŸ‡·' : 
                                            fromCurrency.code === 'EUR' ? 'ğŸ‡ªğŸ‡º' : 
                                            fromCurrency.code === 'USD' ? 'ğŸ‡ºğŸ‡¸' : 
                                            fromCurrency.code === 'JPY' ? 'ğŸ‡¯ğŸ‡µ' : 
                                            fromCurrency.code === 'CNY' ? 'ğŸ‡¨ğŸ‡³' : ''}</div>
                      <div className="font-medium text-xs">{fromCurrency.code}</div>
                    </div>
                  </td>
                  
                  {currencies.map((toCurrency) => {
                    const isSameCurrency = fromCurrency.code === toCurrency.code;
                    const rateData = !isSameCurrency ? getRateData(fromCurrency.code, toCurrency.code) : null;
                    
                    return (
                      <td 
                        key={`${fromCurrency.code}-${toCurrency.code}`} 
                        className={`w-16 h-14 border-2 border-blue-300 text-center ${
                          isSameCurrency ? 'bg-blue-200' : rateData ? getChangeStyle(rateData.change) : ''
                        }`}
                      >
                        {isSameCurrency ? (
                          <span className="font-bold text-gray-400">-</span>
                        ) : rateData ? (
                          <div className="flex flex-col items-center justify-center w-full h-full">
                            <span className="font-medium text-sm">{formatRate(rateData.rate)}</span>
                            <span className={`text-xs ${rateData.change > 0 ? 'text-green-700' : rateData.change < 0 ? 'text-red-700' : 'text-gray-500'}`}>
                              {rateData.change > 0 ? '+' : ''}{rateData.change.toFixed(2)}%
                            </span>
                          </div>
                        ) : (
                          <div className="animate-pulse w-3/4 h-5 bg-gray-200 rounded mx-auto"></div>
                        )}
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};

export default ForexHeatmap; 